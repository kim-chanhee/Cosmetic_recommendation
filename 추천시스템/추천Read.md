
# 하이브리드 추천 시스템 파이프라인 상세 분석
전처리가 완료된 리뷰 데이터를 활용하여 콘텐츠 기반 필터링, 협업 필터링, 그리고 사용자 피부 정보 필터링을 결합한 하이브리드 추천 시스템을 구축하는 전체 과정을 상세히 설명합니다.

### 1단계: 환경 설정 및 데이터 준비
- 목표: 추천 모델 구축에 필요한 라이브러리를 임포트하고, 전처리 및 감성 분석이 완료된 데이터를 불러와 추천 시스템에 적합한 형태로 가공합니다.
- 처리 과정:
  1. 라이브러리 임포트: pandas (데이터 처리), torch 및 transformers (콘텐츠 기반 추천용 KoBERT), surprise (협업 필터링용 SVD), scikit-learn (유사도 계산) 등 모델링에 필요한 라이브러리를 모두 불러옵니다.
  2. 데이터 로딩: 이전 단계에서 생성된 merged_output.csv 파일을 pandas 데이터프레임으로 불러옵니다. 이 파일에는 전처리된 텍스트, 사용자 정보, 감성 분석 예측 결과(pred)가 모두 포함되어 있습니다.
  3. 특성(Feature) 생성:
    - text 컬럼 생성: 콘텐츠 기반 추천의 재료가 되는 텍스트를 만듭니다. 원본 리뷰 review와 핵심 키워드 토큰 Ntoken_review를 합쳐, 각 리뷰의 내용을 풍부하게 표현하는 통합 텍스트를 생성합니다.
    - rating_aug 컬럼 생성: 협업 필터링의 정확도를 높이기 위해 '보정 평점'을 만듭니다. 사용자가 매긴 기존 평점(rating)에 감성 분석 결과(pred)를 0.5의 가중치로 더해, 긍정 리뷰는 평점을 약간 높이고 부정 리뷰는 평점을 약간 낮추는 효과를 줍니다.
  4. 메타데이터 구축: 제품 ID와 내부 인덱스를 서로 변환할 수 있는 사전(item_to_idx, idx_to_item)을 만들어, 모델이 제품을 효율적으로 관리할 수 있도록 합니다.
- 결과: 추천 모델링에 필요한 모든 컬럼이 준비된 df 데이터프레임이 생성됩니다. 총 11,795개의 리뷰와 20개의 고유 제품 데이터가 준비되었습니다.

---

### 2단계: 콘텐츠 기반 추천 (Content-Based Filtering)
- 목표: 사용자가 과거에 긍정적으로 평가한 제품의 텍스트 내용과 유사한 다른 제품을 추천합니다.
- 처리 과정:
  1. KoBERT 모델 로딩: 한국어 자연어 이해에 뛰어난 성능을 보이는 monologg/kobert 모델과 토크나이저를 불러옵니다.
  2. 제품 벡터화: 각 제품(item)에 대한 모든 text 리뷰를 하나로 합친 뒤, KoBERT 모델을 통과시켜 각 제품을 대표하는 고유한 **수치 벡터(Embedding Vector)**로 변환합니다. 이 벡터는 제품의 의미론적 특성을 압축하여 담고 있습니다.
  3. 사용자 프로필 벡터 생성: 특정 사용자가 높게 평가한(평점 4.0 이상) 제품들의 벡터를 가져옵니다. 이 벡터들을 사용자의 실제 평점을 가중치로 하여 가중 평균을 계산, 사용자의 취향을 나타내는 단일 '프로필 벡터'를 생성합니다.
  4. 유사도 계산 및 추천: 생성된 사용자 프로필 벡터와 모든 제품 벡터 간의 **코사인 유사도(Cosine Similarity)**를 계산합니다. 유사도가 높을수록 사용자의 취"향과 제품의 특성이 비슷하다는 의미이며, 가장 유사도가 높은 순서대로 제품을 정렬하여 추천 후보군을 만듭니다.
- 결과: 사용자 ID를 입력하면, 그 사용자의 과거 리뷰 내용을 기반으로 취향에 맞는 제품과 그 유사도 점수를 반환하는 recommend_content_based 함수가 정의됩니다.

---

### 3단계: 협업 필터링 (Collaborative Filtering)
- 목표: '나와 비슷한 취향의 다른 사용자들이 좋아한 제품'을 추천합니다. 개별 제품의 내용이 아닌, 사용자-제품 간의 평점 패턴을 기반으로 합니다.
- 처리 과정:
  1. SVD 모델 학습: surprise 라이브러리를 사용하여 user_id, item_id, 그리고 보정 평점 rating_aug 데이터를 SVD (Singular Value Decomposition) 알고리즘으로 학습시킵니다. SVD는 사용자-제품 평점 행렬에 숨어있는 잠재 요인(Latent Factors)을 찾아내어 사용자와 제품의 특징을 파악합니다.
  2. 평점 예측 및 추천: 학습된 SVD 모델을 사용하여, 특정 사용자가 아직 평가하지 않은 모든 제품에 대한 예상 평점을 예측합니다.
- 결과: 사용자 ID를 입력하면, 모든 제품에 대한 예상 평점을 계산하여 점수가 높은 순으로 추천 결과를 반환하는 recommend_collaborative_filtering 함수가 정의됩니다.

---

### 4단계: 피부 적합도 기반 필터링
- 목표: 추천 결과의 개인화를 극대화하기 위해, 사용자의 피부 프로필(타입, 톤, 고민)에 적합한 제품들만 후보로 남기는 필터를 구현합니다.
- 처리 과정:
  1. 제품별 피부 프로필 집계: 각 제품에 대해, 어떤 피부 타입/톤/고민을 가진 사용자들이 리뷰를 남겼는지 그 비율을 계산하여 피봇 테이블(Pivot Table)을 생성합니다. (예: A 제품 - 건성 리뷰 30%, 지성 50%, 복합성 20%)
  2. 필터링 함수 정의: 추천을 받을 사용자의 피부 프로필(예: 건성, 쿨톤, 각질/모공)을 가져옵니다. 그 후, 위에서 계산한 제품별 피부 프로필 비율이 설정된 기준치(threshold, 예: 10%) 이상인 제품들만 후보군으로 필터링합니다. 즉, '나와 같은 피부 고민을 가진 사람들이 최소 10% 이상은 사용해본 제품'만 남기는 것입니다.
- 결과: 사용자 ID를 입력하면, 해당 사용자의 피부 정보와 맞는 제품들의 목록(set)을 반환하는 filter_items_by_skin_compatibility 함수가 정의됩니다. 이는 최종 추천 대상을 좁혀주는 역할을 합니다.

---

### 5단계: 최종 하이브리드 추천
- 목표: 위에서 구현한 세 가지 요소(콘텐츠 기반, 협업 필터링, 피부 필터)를 모두 결합하여 정교하고 개인화된 최종 추천 결과를 생성합니다.
- 처리 과정:
  1. 1차 필터링 (피부 적합도): filter_items_by_skin_compatibility 함수를 호출하여 사용자의 피부에 맞는 제품 후보군을 먼저 선별합니다. 사용자가 이미 구매한 제품은 이 단계에서 제외됩니다.
  2. 2차 점수 계산 (콘텐츠 + 협업): 필터링된 후보 제품들을 대상으로, 콘텐츠 기반 추천 점수와 협업 필터링 기반 추천 점수를 각각 계산합니다.
  3. 점수 결합 (가중 평균): 두 추천 방식의 점수 범위를 0~1 사이로 정규화(Normalize)한 후, 설정된 **가중치(content_weight)**에 따라 두 점수를 합산하여 최종 점수를 계산합니다. (예: content_weight=0.6이면 콘텐츠 기반 점수를 60%, 협업 필터링 점수를 40% 반영)
  4. 최종 랭킹: 계산된 최종 점수가 높은 순서대로 제품을 정렬하여 상위 K개의 제품을 추천 결과로 제시합니다.



- 결과: 사용자 'vwaaang'에 대한 예시 실행 결과, 피부 정보에 맞는 12개 제품이 필터링되었고, 이들을 대상으로 최종 점수를 계산하여 상위 10개 제품을 DataFrame 형태로 출력했습니다. 추천된 제품은 '마몽드 블루 캐모마일 크림' (점수: 0.879), '낫츠 센텔라스카 연고' (점수: 0.832) 등이 있습니다.
<img width="604" height="338" alt="image" src="https://github.com/user-attachments/assets/19b2e3c6-5ce8-4449-8922-45efe2da3d9c" />

---

< 리뷰 수 상위 10개 제품의 피부 타입별 리뷰 비율>

<img width="1358" height="989" alt="image" src="https://github.com/user-attachments/assets/cd351df6-62dd-4c1b-af82-15c657842986" />
